<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Coaching for Improvement Document</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <style>
    :root{
      --fg:#111; --muted:#4b5563; --border:#cbd5e1; --card:#fff; --bg:#f7f7f8; --accent:#0a66c2;
      --radius:12px;
    }
    @media (prefers-color-scheme: dark){
      :root{ --fg:#eee; --muted:#a3a3a3; --border:#2b2f3a; --card:#12141a; --bg:#0b0c0f; }
    }
    html,body{ height:100%; background:var(--bg); color:var(--fg); -webkit-text-size-adjust:100% }
    body{ margin:0; font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif; line-height:1.25 }
    .page{ max-width:900px; margin:24px auto; background:var(--card); border:1px solid var(--border); border-radius: var(--radius); overflow:hidden }
    .pad{ padding:18px 20px }
    .brand{ text-align:center; padding-top:8px; }
    .brand h1{ font: 700 20px/1.1 -apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif; margin:6px 0 0 }
    .row{ display:grid; grid-template-columns: 2fr 1.2fr 1fr; gap:16px; align-items:end; }
    @media (max-width: 720px){ .row{ grid-template-columns: 1fr; } }

    label{ font-size:13px; color:var(--muted); display:block; margin:2px 0 6px }
    input[type="text"], input[type="date"], textarea{
      width:100%; font-size:16px; /* prevents iOS zoom */ 
      border:1px solid var(--border); border-radius:10px; padding:10px 12px;
      background:var(--card); color:var(--fg); box-sizing:border-box;
    }
    textarea{ min-height:120px; resize:vertical }
    .readonly-pill{
      border:1px dashed var(--border); border-radius:10px; padding:10px 12px; font-size:16px; background:#fafafa;
    }
    .section-title{ font-weight:700; margin:12px 0 6px; }
    .box{ border:1px solid var(--border); border-radius:10px; padding:12px; }
    .checks{ display:grid; grid-template-columns: 1fr 1fr; gap:14px 28px; margin-top:8px }
    .checks label{ display:flex; gap:10px; align-items:center; color:var(--fg); font-size:16px }

    .sig-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:24px; margin-top:16px }
    @media (max-width: 720px){ .sig-grid{ grid-template-columns: 1fr; } }
    .sig-card{ border:1px solid var(--border); border-radius:10px; padding:12px }
    .sig-card h3{ margin:0 0 8px 0; font-size:16px }
    .sig-card canvas{ width:100%; height:160px; border:1px dashed #9aa0a6; border-radius:8px; background:transparent; touch-action:none }
    .sig-actions{ display:flex; gap:10px; margin:8px 0 12px }
    .sig-fields{ display:grid; grid-template-columns: 2fr 1fr; gap:12px; }
    .toolbar{ display:flex; gap:10px; justify-content:flex-end; padding:12px 20px; border-top:1px solid var(--border); background:rgba(0,0,0,.02) }

    button{ font-size:16px; padding:10px 14px; border-radius:10px; border:1px solid var(--border); background:#eef2ff; color:#1f2937; cursor:pointer }
    .primary{ background:var(--accent); color:#fff; border-color:transparent }
    .ok,.err{ display:none; margin-top:10px; padding:10px; border-radius:8px; font-size:14px }
    .ok{ background:#e6f7ed; color:#165c2f; border:1px solid #b7e2c6 }
    .err{ background:#fdecea; color:#611a15; border:1px solid #f5c6cb }

    @media print{
      body{ background:white }
      @page { size: Letter; margin: 0.5in }
      .page{ border:0; border-radius:0; margin:0; max-width:none }
      .toolbar{ display:none !important }
    }
  </style>
</head>
<body>

  <form id="cfi" class="page" novalidate>
    <div class="brand pad">
      <div style="font-weight:800; font-size:22px">Campbell’s <span style="font-weight:600">SNACKS</span></div>
      <h1>Coaching for Improvement Document</h1>
    </div>

    <div class="pad">
      <!-- Top row: Employee Name | Location (read-only) | Date -->
      <div class="row">
        <div>
          <label>Employee Name</label>
          <input type="text" id="empName" name="empName" />
        </div>
        <div>
          <label>Location</label>
          <div class="readonly-pill" id="locationView">Indy Mixing Center</div>
        </div>
        <div>
          <label>Date</label>
          <input type="date" id="date" name="date" />
        </div>
      </div>

      <div class="section-title" style="margin-top:12px">Incident Description</div>
      <div class="box">
        <label>Describe Incident (date, time, location, action):</label>
        <textarea id="incident" name="incident"></textarea>
      </div>

      <div class="section-title" style="margin-top:12px">What policy, procedure or standard was not followed?</div>
      <div class="box">
        <textarea id="policy" name="policy"></textarea>
      </div>

      <div class="section-title" style="margin-top:12px">Action Taken - Coaching for Improvement</div>
      <div class="box">
        <div style="font-weight:700; text-decoration:underline; font-size:14px; color:#374151">Area of Violation</div>
        <div class="checks">
          <label><input type="checkbox" id="viol_conduct"> Conduct</label>
          <label><input type="checkbox" id="viol_performance"> Performance</label>
          <label><input type="checkbox" id="viol_quality"> Quality</label>
          <label><input type="checkbox" id="viol_safety"> Safety</label>
        </div>
      </div>

      <div class="section-title" style="margin-top:12px">Expectations going forward</div>
      <div class="box">
        <textarea id="expectations" name="expectations"></textarea>
      </div>

      <div class="section-title" style="margin-top:12px">Employee Comments</div>
      <div class="box">
        <textarea id="comments" name="comments"></textarea>
      </div>

      <!-- Signatures side-by-side -->
      <div class="sig-grid">
        <!-- Employee -->
        <div class="sig-card">
          <h3>Employee Signature</h3>
          <canvas id="sigEmp"></canvas>
          <div class="sig-actions">
            <button type="button" data-clear="sigEmp">Clear</button>
          </div>
          <div class="sig-fields">
            <div>
              <label>Typed Name</label>
              <input type="text" id="empSigName" placeholder="Employee typed name" />
            </div>
            <div>
              <label>Date</label>
              <input type="date" id="empSigDate" />
            </div>
          </div>
        </div>

        <!-- Supervisor -->
        <div class="sig-card">
          <h3>Supervisor Signature</h3>
          <canvas id="sigSup"></canvas>
          <div class="sig-actions">
            <button type="button" data-clear="sigSup">Clear</button>
          </div>
          <div class="sig-fields">
            <div>
              <label>Typed Name</label>
              <input type="text" id="supSigName" placeholder="Supervisor typed name" />
            </div>
            <div>
              <label>Date</label>
              <input type="date" id="supSigDate" />
            </div>
          </div>
        </div>
      </div>

      <div id="ok" class="ok">Submitted! Your PDF will be saved to SharePoint.</div>
      <div id="err" class="err">Something went wrong. Please try again.</div>
    </div>

    <div class="toolbar">
      <button type="button" id="printBtn">Print / Save PDF</button>
      <button type="submit" class="primary">Submit</button>
    </div>

    <!-- Hidden fields for signature images -->
    <input type="hidden" id="sigEmpData" name="sigEmpData">
    <input type="hidden" id="sigSupData" name="sigSupData">
  </form>

  <!-- Signature Pad -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <script>
    // Paste your Power Automate HTTP trigger URL here:
    const FLOW_URL = "FLOW_URL_HERE";
    const LOCATION_TEXT = "Indy Mixing Center"; // shown as read-only

    // Canvas + SignaturePad setup
    const empCanvas = document.getElementById('sigEmp');
    const supCanvas = document.getElementById('sigSup');
    const empPad = new SignaturePad(empCanvas, { penColor:'black' });
    const supPad = new SignaturePad(supCanvas, { penColor:'black' });

    function fitCanvas(c, pad){
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      const rect = c.getBoundingClientRect();
      c.width = rect.width * ratio;
      c.height = rect.height * ratio;
      c.getContext('2d').scale(ratio, ratio);
      pad.clear();
    }
    function resizeAll(){ fitCanvas(empCanvas, empPad); fitCanvas(supCanvas, supPad); }
    window.addEventListener('resize', resizeAll);
    resizeAll();

    // Clear buttons
    document.querySelectorAll('[data-clear]').forEach(btn=>{
      btn.addEventListener('click', ()=> {
        (btn.getAttribute('data-clear') === 'sigEmp' ? empPad : supPad).clear();
      });
    });

    // Print (local)
    document.getElementById('printBtn').addEventListener('click', ()=>{
      storeSigs();
      window.print();
    });

    function storeSigs(){
      document.getElementById('sigEmpData').value = empPad.isEmpty() ? "" : empPad.toDataURL('image/png');
      document.getElementById('sigSupData').value = supPad.isEmpty() ? "" : supPad.toDataURL('image/png');
    }

    // Submit → POST JSON to Flow
    const form = document.getElementById('cfi');
    const ok = document.getElementById('ok');
    const err = document.getElementById('err');

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      ok.style.display='none'; err.style.display='none';
      storeSigs();

      const body = {
        employeeName: document.getElementById('empName').value || "",
        date: document.getElementById('date').value || "",
        location: LOCATION_TEXT,
        incident: document.getElementById('incident').value || "",
        policy: document.getElementById('policy').value || "",
        expectations: document.getElementById('expectations').value || "",
        comments: document.getElementById('comments').value || "",
        areaOfViolation: {
          conduct: document.getElementById('viol_conduct').checked,
          performance: document.getElementById('viol_performance').checked,
          quality: document.getElementById('viol_quality').checked,
          safety: document.getElementById('viol_safety').checked
        },
        sigEmployee: document.getElementById('sigEmpData').value || "",
        sigSupervisor: document.getElementById('sigSupData').value || "",
        empSigName: document.getElementById('empSigName').value || "",
        empSigDate: document.getElementById('empSigDate').value || "",
        supSigName: document.getElementById('supSigName').value || "",
        supSigDate: document.getElementById('supSigDate').value || ""
      };

      // Build print-ready HTML for Flow (includes images + typed name + dates)
      const check = (b)=> b ? "☑" : "☐";
      body.html = `
<!doctype html>
<html><head><meta charset="utf-8">
<style>
  body{font-family:Arial, sans-serif; margin:28px;}
  h1{margin:0 0 6px 0}
  .grid3{display:grid; grid-template-columns: 2fr 1.2fr 1fr; gap:12px}
  .row{margin:6px 0}
  .label{font-weight:bold; display:inline-block; width:220px}
  .box{border:1px solid #cbd5e1; padding:10px; min-height:80px}
  .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:16px}
  hr{border:0; border-top:1px solid #cbd5e1; margin:12px 0}
  @page{ size: Letter; margin: .5in }
</style></head><body>
  <div style="text-align:center;font-weight:800;font-size:20px">Campbell’s <span style="font-weight:600">SNACKS</span></div>
  <h1>Coaching for Improvement Document</h1>

  <div class="grid3">
    <div class="row"><span class="label">Employee Name:</span> ${esc(body.employeeName)}</div>
    <div class="row"><span class="label">Location:</span> ${esc(body.location)}</div>
    <div class="row"><span class="label">Date:</span> ${esc(body.date)}</div>
  </div>

  <div class="row" style="margin-top:8px"><b>Incident Description</b></div>
  <div class="row">Describe Incident (date, time, location, action):</div>
  <div class="box">${esc(body.incident).replace(/\n/g,"<br>")}</div>

  <div class="row" style="margin-top:8px"><b>What policy, procedure or standard was not followed?</b></div>
  <div class="box">${esc(body.policy).replace(/\n/g,"<br>")}</div>

  <div class="row" style="margin-top:8px"><b>Action Taken - Coaching for Improvement</b></div>
  <div class="row" style="text-decoration:underline">Area of Violation</div>
  <div class="grid2">
    <div>${check(body.areaOfViolation.conduct)} Conduct</div>
    <div>${check(body.areaOfViolation.performance)} Performance</div>
    <div>${check(body.areaOfViolation.quality)} Quality</div>
    <div>${check(body.areaOfViolation.safety)} Safety</div>
  </div>

  <div class="row" style="margin-top:8px"><b>Expectations going forward</b></div>
  <div class="box">${esc(body.expectations).replace(/\n/g,"<br>")}</div>

  <div class="row" style="margin-top:8px"><b>Employee Comments</b></div>
  <div class="box">${esc(body.comments).replace(/\n/g,"<br>")}</div>

  <hr>
  <div class="grid2">
    <div>
      <div class="row"><b>Employee Signature</b></div>
      ${body.sigEmployee ? '<img src="'+body.sigEmployee+'" style="max-width:320px;border:1px solid #000">' : '<em>(no signature)</em>'}
      <div class="row"><span class="label">Typed Name:</span> ${esc(body.empSigName)}</div>
      <div class="row"><span class="label">Date:</span> ${esc(body.empSigDate)}</div>
    </div>
    <div>
      <div class="row"><b>Supervisor Signature</b></div>
      ${body.sigSupervisor ? '<img src="'+body.sigSupervisor+'" style="max-width:320px;border:1px solid #000">' : '<em>(no signature)</em>'}
      <div class="row"><span class="label">Typed Name:</span> ${esc(body.supSigName)}</div>
      <div class="row"><span class="label">Date:</span> ${esc(body.supSigDate)}</div>
    </div>
  </div>
</body></html>`.trim();

      try{
        const resp = await fetch(FLOW_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(body)
        });
        if(!resp.ok) throw new Error(await resp.text());
        ok.style.display='block';
      }catch(e2){
        err.textContent = "Error submitting: " + (e2.message || e2);
        err.style.display='block';
      }
    });

    function esc(s){ return (s||"").replace(/[&<>"]/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;" ,'"':"&quot;" }[m])); }
  </script>
</body>
</html>
