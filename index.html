<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Coaching for Improvement Document</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <style>
    :root{
      --fg:#111; --muted:#4b5563; --border:#cbd5e1; --card:#fff; --bg:#f7f7f8; --accent:#0a66c2;
      --radius:12px; --print-zoom:0.90;
      --success-fg:#165c2f; --success-border:#b7e2c6;
    }
    @media (prefers-color-scheme: dark){
      :root{ --fg:#eee; --muted:#a3a3a3; --border:#2b2f3a; --card:#12141a; --bg:#0b0c0f; }
    }
    html, body { height:100%; background:var(--bg); color:var(--fg); -webkit-text-size-adjust:100%; overscroll-behavior: contain; }
    body { margin:0; font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif; line-height:1.25; }

    .page { max-width:900px; margin:20px auto; background:var(--card); border:1px solid var(--border); border-radius: var(--radius); overflow:hidden; }
    .pad { padding:12px 16px; }

    .brand { text-align:center; padding:16px 16px 8px; }
    .wordmark { font-weight:900; font-size:28px; line-height:1.1; margin:0 auto 8px; }
    .wordmark .campbells { color:#BA0018; }
    .wordmark .snacks { color:#FFAD00; }
    .brand h1 { text-align:center; font:700 20px/1.15 -apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif; margin:6px 0 0; }

    .row { display:grid; grid-template-columns: 2fr 1.2fr 1fr; gap:12px; align-items:end; }
    @media (max-width: 720px){ .row{ grid-template-columns: 1fr; } }

    label { font-size:13px; color:var(--muted); display:block; margin:2px 0 6px; }
    input[type="text"], input[type="date"], textarea {
      width:100%; font-size:16px; border:1px solid var(--border); border-radius:10px; padding:8px 9px;
      background:var(--card); color:var(--fg); box-sizing:border-box;
    }
    textarea { min-height:64px; resize:vertical; }

    .readonly-pill { border:1px dashed var(--border); border-radius:10px; padding:8px 9px; font-size:16px; background:#fafafa; }
    .section-title { font-weight:700; margin:10px 0 6px; }
    .box { border:1px solid var(--border); border-radius:10px; padding:8px; }

    .checks-inline { display:flex; gap:18px; flex-wrap:wrap; align-items:center; }
    .checks-inline label { display:flex; gap:8px; align-items:center; color:var(--fg); font-size:16px; margin:4px 0 0; }

    .sig-grid { display:grid; grid-template-columns: 1fr 1fr; gap:18px; margin-top:10px; }
    @media (max-width: 720px){ .sig-grid{ grid-template-columns: 1fr; } }

    .sig-card { border:1px solid var(--border); border-radius:10px; padding:10px; }
    .sig-card h3 { margin:0 0 6px 0; font-size:16px; text-align:left; }

    .sig-card canvas {
      width:100%; height:140px; border:1px dashed #9aa0a6; border-radius:8px; background:transparent;
      touch-action:none; -ms-touch-action:none; -webkit-user-select:none; user-select:none; -webkit-touch-callout:none;
      position:relative; z-index:1; display:block;
    }

    .sig-actions { display:flex; gap:10px; margin:6px 0 8px; }
    .sig-fields { display:grid; grid-template-columns: 2fr 1fr; gap:10px; }

    .toolbar { display:flex; gap:10px; justify-content:flex-end; padding:10px 16px; border-top:1px solid var(--border); background:rgba(0,0,0,.02); }
    button { font-size:16px; padding:8px 12px; border-radius:10px; border:1px solid var(--border); background:#eef2ff; color:#1f2937; cursor:pointer; }
    .primary { background:var(--accent); color:#fff; border-color:transparent; }

    .err { display:none; margin-top:8px; padding:10px; border-radius:8px; font-size:14px; background:#fdecea; color:#611a15; border:1px solid #f5c6cb; }

    .overlay{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.45); z-index:9999; }
    .overlay.show{ display:grid; }
    .success-card{
      background:var(--card); color:var(--success-fg); border:1px solid var(--success-border);
      border-radius:16px; padding:20px 24px; text-align:center; min-width:260px; max-width:92vw;
      box-shadow:0 10px 30px rgba(0,0,0,.15); animation:pop .28s ease-out;
    }
    @keyframes pop{ from{ transform:scale(.9); opacity:0 } to{ transform:scale(1); opacity:1 } }
    .check-wrap{ width:96px; height:96px; margin:6px auto 10px; }
    .check-wrap svg{ width:100%; height:100%; display:block; }
    .draw-circle{ stroke-dasharray: 300; stroke-dashoffset: 300; animation: draw 700ms ease-out forwards; }
    .draw-check{ stroke-dasharray: 100; stroke-dashoffset: 100; animation: draw 500ms ease-out forwards 200ms; }

    .closebtn{
      margin-top:12px; display:inline-flex; align-items:center; justify-content:center;
      font-size:15px; padding:8px 12px; border-radius:10px; border:1px solid var(--border);
      background:#eff6ff; color:#0b3b85; cursor:pointer;
    }

    .step { display:none; }
    .step.active { display:block; }
    .intro-card { padding:16px; border-top:1px solid var(--border); }
    .viol-grid { display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px; }
    @media (max-width:720px){ .viol-grid{ grid-template-columns:1fr; } }
    .viol-opt, .qa-opt { display:flex; align-items:center; gap:10px; border:1px solid var(--border); border-radius:10px; padding:12px; }
    .qa-group{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin:8px 0; }
    .muted{ color: var(--muted); font-size: 14px; }

    @media print{
      body{ background:white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      @page { size: Letter; margin: 0.5in; }
      html, body { zoom: var(--print-zoom); }
      .page{ width: calc(8.5in - 1in); margin: 0 auto; border:0; border-radius:0; }
      .wordmark { font-size:20px; }
      .brand h1{ font-size:18px; }
      .pad{ padding:8px 10px; }
      .row{ gap:8px; }
      label{ font-size:11px; }
      input[type="text"], input[type="date"], textarea{ font-size:12px; padding:6px 7px; }
      .section-title{ margin:6px 0 4px; }
      .box{ padding:6px; }
      .sig-card canvas{ height:110px; }
      .checks-inline label{ font-size:12px; }
      .toolbar, .overlay, #step1 { display:none !important; }
      #step2 { display:block !important; }
    }
  </style>
</head>
<body>

  <form id="cfi" class="page" novalidate>
    <div class="brand pad">
      <div class="wordmark" aria-label="Campbell's Snacks">
        <span class="campbells">Campbell's</span> <span class="snacks">Snacks</span>
      </div>
      <h1>Coaching for Improvement Document</h1>
    </div>

    <!-- Step 1 -->
    <section id="step1" class="step active">
      <div class="intro-card pad">
        <div class="section-title">Employee/Temp Information</div>

        <div style="margin-top:6px">
          <label style="font-weight:700">Is this employee a temp?</label>
          <div class="qa-group" role="radiogroup" aria-label="Is this employee a temp">
            <label class="qa-opt"><input type="radio" name="isTemp" value="no"> No</label>
            <label class="qa-opt"><input type="radio" name="isTemp" value="yes"> Yes</label>
          </div>
        </div>

        <div id="agencyWrap" style="display:none; margin-top:6px">
          <label style="font-weight:700">Select the Agency:</label>
          <div class="qa-group" role="radiogroup" aria-label="Temp agency">
            <label class="qa-opt"><input type="radio" name="tempAgency" value="Energeo">Energeo</label>
            <label class="qa-opt"><input type="radio" name="tempAgency" value="Elwood">Elwood</label>
            <label class="qa-opt"><input type="radio" name="tempAgency" value="Coworx">Coworx</label>
          </div>
        </div>

        <hr style="border:none;border-top:1px solid var(--border); margin:12px 0">

        <p class="muted" style="margin:6px 0 10px">Choose the applicable area(s) of violation. We'll prefill the <b>Policy</b> and <b>Expectations</b> sections. You can still edit them before submitting.</p>
        <div class="viol-grid" role="group">
          <div class="viol-opt"><label><input type="checkbox" id="s1_conduct"> Conduct</label></div>
          <div class="viol-opt"><label><input type="checkbox" id="s1_performance"> Performance</label></div>
          <div class="viol-opt"><label><input type="checkbox" id="s1_quality"> Quality</label></div>
          <div class="viol-opt"><label><input type="checkbox" id="s1_safety"> Safety</label></div>
        </div>

        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:14px">
          <button type="button" id="startFormBtn" class="primary">Continue to form</button>
        </div>
      </div>
    </section>

    <!-- Step 2 -->
    <section id="step2" class="step">
      <div class="pad">

        <!-- FIRST: Name / Location / Date -->
        <div class="row">
          <div>
            <label>Employee Name</label>
            <input type="text" id="empName" name="empName" />
          </div>
          <div>
            <label>Location</label>
            <div class="readonly-pill" id="locationView">Indy Mixing Center</div>
          </div>
          <div>
            <label>Date</label>
            <input type="text" id="date" name="date" class="pill-input" readonly aria-readonly="true" />
          </div>
        </div>

        <!-- THEN: Temp Status / Agency -->
        <div class="row" style="margin-top:4px">
          <div>
            <label>Temp Status</label>
            <div class="readonly-pill" id="tempStatusView">—</div>
          </div>
          <div>
            <label>Agency</label>
            <div class="readonly-pill" id="tempAgencyView">—</div>
          </div>
          <div></div>
        </div>

        <div class="section-title" style="margin-top:8px">Incident Description</div>
        <div class="box">
          <label>Describe Incident (date, time, location, action):</label>
          <textarea id="incident" name="incident"></textarea>
        </div>

        <div class="section-title" style="margin-top:8px">What policy, procedure or standard was not followed?</div>
        <div class="box">
          <textarea id="policy" name="policy"></textarea>
        </div>

        <div class="section-title" style="margin-top:8px">Action Taken - Coaching for Improvement</div>
        <div class="box">
          <div style="font-weight:700; text-decoration:underline; font-size:14px; color:#374151">Area of Violation</div>
          <div class="checks-inline">
            <label><input type="checkbox" id="viol_conduct"> Conduct</label>
            <label><input type="checkbox" id="viol_performance"> Performance</label>
            <label><input type="checkbox" id="viol_quality"> Quality</label>
            <label><input type="checkbox" id="viol_safety"> Safety</label>
          </div>
        </div>

        <div class="section-title" style="margin-top:8px">Expectations going forward</div>
        <div class="box">
          <textarea id="expectations" name="expectations"></textarea>
        </div>

        <div class="section-title" style="margin-top:8px">Employee Comments</div>
        <div class="box">
          <textarea id="comments" name="comments"></textarea>
        </div>

        <div class="sig-grid">
          <div class="sig-card">
            <h3>Employee Signature</h3>
            <canvas id="sigEmp"></canvas>
            <div class="sig-actions">
              <button type="button" data-clear="sigEmp">Clear</button>
            </div>
            <div class="sig-fields">
              <div>
                <label>Typed Name</label>
                <input type="text" id="empSigName" placeholder="Employee typed name" />
              </div>
              <div>
                <label>Date</label>
                <input type="text" id="empSigDate" class="pill-input" readonly aria-readonly="true" />
              </div>
            </div>
          </div>

          <div class="sig-card">
            <h3>Supervisor Signature</h3>
            <canvas id="sigSup"></canvas>
            <div class="sig-actions">
              <button type="button" data-clear="sigSup">Clear</button>
            </div>
            <div class="sig-fields">
              <div>
                <label>Typed Name</label>
                <input type="text" id="supSigName" placeholder="Supervisor typed name" />
              </div>
              <div>
                <label>Date</label>
                <input type="text" id="supSigDate" class="pill-input" readonly aria-readonly="true" />
              </div>
            </div>
          </div>
        </div>

        <div id="err" class="err">Something went wrong. Please try again.</div>
      </div>

      <div class="toolbar">
        <button type="button" id="backBtn">Back</button>
        <button type="button" id="printBtn">Print / Save PDF</button>
        <button type="submit" class="primary" id="submitBtn">Submit</button>
      </div>

      <input type="hidden" id="sigEmpData" name="sigEmpData">
      <input type="hidden" id="sigSupData" name="sigSupData">
    </section>
  </form>

  <!-- Success overlay -->
  <div id="successOverlay" class="overlay" aria-modal="true" role="dialog">
    <div class="success-card" role="document" onclick="event.stopPropagation()">
      <div class="check-wrap" aria-hidden="true" id="checkWrap">
        <svg viewBox="0 0 120 120">
          <circle class="draw-circle" cx="60" cy="60" r="48" fill="none" stroke="#22c55e" stroke-width="8" />
          <path class="draw-check" d="M36 64 L54 78 L86 42" fill="none" stroke="#16a34a" stroke-width="10" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <div id="successMsg" style="font-weight:700; font-size:18px; color:#14532d">Submitting…</div>
      <button type="button" class="closebtn" id="closeOverlay">Close</button>
    </div>
  </div>

  <script>
    const FLOW_URL = "https://defaulta0a180f0657a438b891f49417a6dd8.bc.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/0d1fb5e1ec1c4f4b83da2eb6074fb72c/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=vLQMDKpnjabByDyPSdGecNMyfCtDKcTqA7GW3tuWu9Y";

    const TEMPLATES = {
      conduct: {
        policy: `In accordance with Logistics Corrective Action Guidelines, this coaching falls under the Conduct category.`,
        expectations: `Demonstrate professional, respectful conduct at all times. Follow leader direction, use appropriate language, and escalate concerns through the correct channels. Future incidents may lead to further coaching and/or corrective action.`
      },
      performance: {
        policy: `In accordance with Logistics Corrective Action Guidelines, this coaching falls under the Performance category and is guided by the Warehouse Labor Management Policy.`,
        expectations: `Meet or exceed performance standards. Ask for clarification when unsure, request help early, and use available tools/training. Sustain improvement on upcoming shifts.`
      },
      quality: {
        policy: `In accordance with Logistics Corrective Action Guidelines, this coaching falls under the Quality category.`,
        expectations: `Follow all quality checks and documentation. Verify counts before moves, correct errors immediately, and report issues to a lead or supervisor.`
      },
      safety: {
        policy: `In accordance with Logistics Corrective Action Guidelines, this coaching falls under the Safety category.`,
        expectations: `Work safely without shortcuts. Wear PPE, maintain safe speeds, perform required checks, and stop/ask if conditions are unsafe. Report hazards immediately.`
      }
    };

    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const startFormBtn = document.getElementById('startFormBtn');
    const backBtn = document.getElementById('backBtn');

    const isTempRadios = Array.from(document.querySelectorAll('input[name="isTemp"]'));
    const agencyWrap = document.getElementById('agencyWrap');

    isTempRadios.forEach(r => {
      r.addEventListener('change', () => {
        if (r.value === 'yes' && r.checked) {
          agencyWrap.style.display = 'block';
        } else if (r.value === 'no' && r.checked) {
          agencyWrap.style.display = 'none';
          document.querySelectorAll('input[name="tempAgency"]').forEach(a => a.checked = false);
        }
      });
    });

    function fillTodayDates() {
      const d = new Date();
      const iso = d.toLocaleDateString(undefined, { year: "numeric", month: "2-digit", day: "2-digit" });
      ["date", "empSigDate", "supSigDate"].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = iso;
      });
    }
    document.addEventListener("DOMContentLoaded", fillTodayDates);
    document.getElementById("startFormBtn")?.addEventListener("click", fillTodayDates);

    function gotoStep(n){
      step1.classList.toggle('active', n===1);
      step2.classList.toggle('active', n===2);
      window.scrollTo({top:0, behavior:'smooth'});
    }

    startFormBtn.addEventListener('click', () => {
      const chosenTemp = isTempRadios.find(r => r.checked)?.value || "";
      if (!chosenTemp) { alert("Please answer: Is this employee a temp?"); return; }

      let chosenAgency = "";
      if (chosenTemp === "yes") {
        const a = document.querySelector('input[name="tempAgency"]:checked');
        if (!a) { alert("Please select the temp agency."); return; }
        chosenAgency = a.value;
      }

      document.getElementById('tempStatusView').textContent = chosenTemp === "yes" ? "Yes" : "No";
      document.getElementById('tempAgencyView').textContent = chosenTemp === "yes" ? chosenAgency : "—";

      const sel = {
        conduct: document.getElementById('s1_conduct').checked,
        performance: document.getElementById('s1_performance').checked,
        quality: document.getElementById('s1_quality').checked,
        safety: document.getElementById('s1_safety').checked
      };
      document.getElementById('viol_conduct').checked = sel.conduct;
      document.getElementById('viol_performance').checked = sel.performance;
      document.getElementById('viol_quality').checked = sel.quality;
      document.getElementById('viol_safety').checked = sel.safety;

      const chosenKeys = Object.keys(sel).filter(k => sel[k]);
      const prePolicy = chosenKeys.map(k => `• ${TEMPLATES[k].policy}`).join('\n');
      const preExpect = chosenKeys.map(k => `• ${TEMPLATES[k].expectations}`).join('\n');
      document.getElementById('policy').value = prePolicy;
      document.getElementById('expectations').value = preExpect;

      form.dataset.isTemp = chosenTemp;
      form.dataset.tempAgency = chosenTemp === "yes" ? chosenAgency : "";

      gotoStep(2);
    });

    backBtn.addEventListener('click', ()=> gotoStep(1));

    function initSignatureCanvas(canvas){
      const ctx = canvas.getContext('2d');
      ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.strokeStyle = '#000'; ctx.lineWidth = 2.0;
      let drawing=false, prev=null, isEmpty=true;

      function fit(){
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        const rect = canvas.getBoundingClientRect();
        canvas.width  = Math.max(1, Math.floor(rect.width  * ratio));
        canvas.height = Math.max(1, Math.floor(rect.height * ratio));
        ctx.setTransform(ratio,0,0,ratio,0,0);
        ctx.lineCap='round'; ctx.lineJoin='round'; ctx.strokeStyle='#000'; ctx.lineWidth=2.0;
      }
      function pos(e){ const r=canvas.getBoundingClientRect(); return {x:e.clientX-r.left, y:e.clientY-r.top}; }

      canvas.addEventListener('pointerdown', e=>{
        if (e.pointerType==='mouse' && e.button!==0) return;
        canvas.setPointerCapture?.(e.pointerId);
        drawing=true; prev=pos(e); isEmpty=false; e.preventDefault();
      }, {passive:false});
      canvas.addEventListener('pointermove', e=>{
        if(!drawing) return;
        const p=pos(e); ctx.beginPath(); ctx.moveTo(prev.x,prev.y); ctx.lineTo(p.x,p.y); ctx.stroke(); prev=p; e.preventDefault();
      }, {passive:false});
      function end(e){ drawing=false; prev=null; canvas.releasePointerCapture?.(e.pointerId); e.preventDefault(); }
      canvas.addEventListener('pointerup', end, {passive:false});
      canvas.addEventListener('pointercancel', end, {passive:false});
      canvas.addEventListener('pointerleave', end, {passive:false});

      const block = ev => ev.preventDefault();
      canvas.addEventListener('touchstart', block, {passive:false});
      canvas.addEventListener('touchmove',  block, {passive:false});

      new ResizeObserver(()=>requestAnimationFrame(fit)).observe(canvas.parentElement);
      addEventListener('orientationchange', ()=>setTimeout(fit,150));
      requestAnimationFrame(fit);

      return { clear(){ ctx.clearRect(0,0,canvas.width,canvas.height); isEmpty=true; },
               toDataURL(){ return canvas.toDataURL('image/png'); },
               isEmpty(){ return isEmpty; } };
    }

    const empPad = initSignatureCanvas(document.getElementById('sigEmp'));
    const supPad = initSignatureCanvas(document.getElementById('sigSup'));

    document.querySelectorAll('[data-clear]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        (btn.getAttribute('data-clear')==='sigEmp'?empPad:supPad).clear();
      });
    });

    document.getElementById('printBtn').addEventListener('click', ()=>{ storeSigs(); window.print(); });

    function storeSigs(){
      document.getElementById('sigEmpData').value = empPad.isEmpty() ? "" : empPad.toDataURL();
      document.getElementById('sigSupData').value = supPad.isEmpty() ? "" : supPad.toDataURL();
    }

    function clearFormUI(){
      const form=document.getElementById('cfi');
      form.reset();
      empPad.clear(); supPad.clear();
      document.getElementById('sigEmpData').value = '';
      document.getElementById('sigSupData').value = '';
      isTempRadios.forEach(r=> r.checked=false);
      document.querySelectorAll('input[name="tempAgency"]').forEach(a => a.checked=false);
      document.getElementById('tempStatusView').textContent='—';
      document.getElementById('tempAgencyView').textContent='—';
      agencyWrap.style.display='none';
      gotoStep(1);
    }

    const overlay = document.getElementById('successOverlay');
    const successMsgEl = document.getElementById('successMsg');
    const closeBtn = document.getElementById('closeOverlay');
    const checkWrap = document.getElementById('checkWrap');

    function restartCheckAnimation(){
      const svg = checkWrap.querySelector('svg');
      const clone = svg.cloneNode(true);
      svg.replaceWith(clone);
    }
    function showOverlay(initialText){
      successMsgEl.textContent = initialText || 'Submitting…';
      restartCheckAnimation();
      overlay.classList.add('show');
    }
    function setOverlayText(t){ successMsgEl.textContent = t; }
    function hideOverlay(){ overlay.classList.remove('show'); }
    closeBtn.onclick = () => hideOverlay();

    const form = document.getElementById('cfi');
    const err  = document.getElementById('err');
    const submitBtn = document.getElementById('submitBtn');

    const empNameEl = document.getElementById('empName');
    const empSigNameEl = document.getElementById('empSigName');
    let sigManuallyEdited = false;
    empSigNameEl.addEventListener('input', () => { sigManuallyEdited = true; });
    empNameEl?.addEventListener('input', () => {
      if (!sigManuallyEdited) empSigNameEl.value = empNameEl.value;
    });

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      err.style.display='none';
      submitBtn.disabled = true;

      showOverlay('Submitting…');

      storeSigs();

      const isTemp = (form.dataset.isTemp || "").toLowerCase();
      const tempAgency = form.dataset.tempAgency || "";

      const body = {
        employeeName: document.getElementById('empName').value || "",
        date: document.getElementById('date').value || "",
        location: "Indy Mixing Center",
        isTemp: isTemp === "yes",
        tempAgency: isTemp === "yes" ? tempAgency : "",
        incident: document.getElementById('incident').value || "",
        policy: document.getElementById('policy').value || "",
        expectations: document.getElementById('expectations').value || "",
        comments: document.getElementById('comments').value || "",
        areaOfViolation: {
          conduct: document.getElementById('viol_conduct').checked,
          performance: document.getElementById('viol_performance').checked,
          quality: document.getElementById('viol_quality').checked,
          safety: document.getElementById('viol_safety').checked
        },
        sigEmployee: document.getElementById('sigEmpData').value || "",
        sigSupervisor: document.getElementById('sigSupData').value || "",
        empSigName: document.getElementById('empSigName').value || "",
        empSigDate: document.getElementById('empSigDate').value || "",
        supSigName: document.getElementById('supSigName').value || "",
        supSigDate: document.getElementById('supSigDate').value || ""
      };

      const check = (b)=> b ? "☑" : "☐";
      const wordmark = '<div style="text-align:center;font-weight:900;font-size:18px"><span style="color:#BA0018">Campbell&#39;s</span> <span style="color:#FFAD00">Snacks</span></div>';

      body.html = `
<!doctype html>
<html><head><meta charset="utf-8">
<style>
  body{font-family:Arial, sans-serif; margin:28px;}
  h1{margin:6px 0 6px 0; text-align:center}
  .grid3{display:grid; grid-template-columns: 2fr 1.2fr 1fr; gap:8px}
  .row{margin:4px 0}
  .label{font-weight:bold; display:inline-block; width:200px}
  .box{border:1px solid #cbd5e1; padding:6px; min-height:56px}
  .line{display:flex; gap:16px; flex-wrap:wrap; align-items:center; margin:6px 0}
  .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
  @page{ size: Letter; margin: .5in }
</style></head><body>
  ${wordmark}
  <h1>Coaching for Improvement Document</h1>

  <div class="grid3">
    <div class="row"><span class="label">Employee Name:</span> ${esc(body.employeeName)}</div>
    <div class="row"><span class="label">Location:</span> ${esc(body.location)}</div>
    <div class="row"><span class="label">Date:</span> ${esc(body.date)}</div>
  </div>

  <div class="grid3" style="margin-top:4px">
    <div class="row"><span class="label">Is Temp:</span> ${body.isTemp ? 'Yes' : 'No'}</div>
    ${body.isTemp ? `<div class="row"><span class="label">Temp Agency:</span> ${esc(body.tempAgency)}</div>` : `<div class="row"></div>`}
    <div class="row"></div>
  </div>

  <div class="row" style="margin-top:6px"><b>Incident Description</b></div>
  <div class="row">Describe Incident (date, time, location, action):</div>
  <div class="box">${esc(body.incident).replace(/\n/g,"<br>")}</div>

  <div class="row" style="margin-top:6px"><b>What policy, procedure or standard was not followed?</b></div>
  <div class="box">${esc(body.policy).replace(/\n/g,"<br>")}</div>

  <div class="row" style="margin-top:6px"><b>Action Taken - Coaching for Improvement</b></div>
  <div class="row" style="text-decoration:underline">Area of Violation</div>
  <div class="line">
    <div>${check(body.areaOfViolation.conduct)} Conduct</div>
    <div>${check(body.areaOfViolation.performance)} Performance</div>
    <div>${check(body.areaOfViolation.quality)} Quality</div>
    <div>${check(body.areaOfViolation.safety)} Safety</div>
  </div>

  <div class="row" style="margin-top:6px"><b>Expectations going forward</b></div>
  <div class="box">${esc(body.expectations).replace(/\n/g,"<br>")}</div>

  <div class="row" style="margin-top:6px"><b>Employee Comments</b></div>
  <div class="box">${esc(body.comments).replace(/\n/g,"<br>")}</div>

  <div class="grid2" style="margin-top:8px">
    <div>
      <div class="row"><b>Employee Signature</b></div>
      ${body.sigEmployee ? '<img src="'+body.sigEmployee+'" style="max-width:280px;border:1px solid #000">' : '<em>(no signature)</em>'}
      <div class="row"><span class="label">Typed Name:</span> ${esc(body.empSigName)}</div>
      <div class="row"><span class="label">Date:</span> ${esc(body.empSigDate)}</div>
    </div>
    <div>
      <div class="row"><b>Supervisor Signature</b></div>
      ${body.sigSupervisor ? '<img src="'+body.sigSupervisor+'" style="max-width:280px;border:1px solid #000">' : '<em>(no signature)</em>'}
      <div class="row"><span class="label">Typed Name:</span> ${esc(body.supSigName)}</div>
      <div class="row"><span class="label">Date:</span> ${esc(body.supSigDate)}</div>
    </div>
  </div>
</body></html>`.trim();

      try{
        const resp = await fetch(FLOW_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(body)
        });
        if(!resp.ok) throw new Error(await resp.text());

        setOverlayText('Submitted!');
        clearFormUI();
      }catch(e2){
        hideOverlay();
        err.textContent = "Error submitting: " + (e2.message || e2);
        err.style.display='block';
      } finally {
        submitBtn.disabled = false;
      }
    });

    function esc(s){ return (s||"").replace(/[&<>"]/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;" }[m])); }
  </script>
</body>
</html>
